<!DOCTYPE html>
<html>

<head>
    <title>Dice Success Probability Comparator</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_name=delete_forever+arrow_left+arrow_right+content_copy" />
    <link rel="stylesheet" href="./index.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="./main.js"></script> -->
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    <div style="max-width: 80%; margin-left: auto; margin-right: auto;">
        <canvas id="chart"></canvas>
    </div>
    <div style="padding: 20px;">
        <div style="display: flex; justify-content: space-between;">
            <div>
                <button class="add-config-btn" onclick="addConfiguration()">Add Configuration</button>
            </div>
            <div>
                <button onclick="runSimulation()">Run Simulation</button>
            </div>
        </div>
        <div id="configurations-container"></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
            <div style="display: flex; gap: 10px;">
                <button onclick="toggleYAxis()">Toggle Y-Axis Lock (0-100%)</button>
                <button onclick="exportToCSV()">Export to CSV</button>
                <button onclick="importFromCSV()">Import from CSV</button>
                <button onclick="exportToJSON()">Export JSON</button>
                <button onclick="importFromJSON()">Import JSON</button>
            </div>
            <input id="num-trials-input" type="number" value="50000" />
        </div>
        <input id="csv-file-input" type="file" accept=".csv" style="display: none;" />
        <input id="json-file-input" type="file" accept=".json" style="display: none;" />
    </div>

    <script>
        // Element Constants
        const csvFileInput = document.getElementById('csv-file-input')
        const jsonFileInput = document.getElementById('json-file-input')
        const numTrialsInput = document.getElementById('num-trials-input')

        // Variables
        let chart = null;
        let yAxisLocked = true;
        let currentData = null;
        let configCounter = 0;

        // Handlers
        window.onload = () => {
            addConfiguration();
            runSimulation()
        }

        csvFileInput.onchange = async e => {
            try {
                const file = e.target.files[0];
                if (!file) return;

                const text = await file.text();
                const rows = text.split('\n').map(row => row.split(','));
                const headers = rows[0];
                const configCount = (headers.length - 1) / 2;

                clearExistingConfigs();

                for (let i = 0; i < configCount; i++) {
                    addConfiguration();
                }

                const configs = document.querySelectorAll('.config-box');
                configs.forEach((config, index) => {
                    const [name, color, lineStyle] = headers[index + 1].split('|');
                    const diceValues = rows[1][index + 1 + configCount].split('/').map(Number);

                    config.querySelector('.config-name').value = name;
                    config.querySelector('.color-picker').value = color;
                    config.querySelector('.line-style').value = lineStyle || 'solid';
                    const inputs = config.querySelectorAll('input[type="number"]:not(.config-name)');
                    inputs[0].value = diceValues[0];
                    inputs[1].value = diceValues[1];
                    inputs[2].value = diceValues[2];
                });

                updateConfigNames();
                runSimulation();
            } catch (error) {
                alert('Invalid CSV file: ' + error.message);
            }

        };

        jsonFileInput.onchange = async (e) => {
            try {
                const file = e.target.files[0];
                if (!file) return;

                const text = await file.text();
                const configs = JSON.parse(text);

                clearExistingConfigs();

                configs.forEach(config => addConfiguration({
                    name: config.name,
                    color: config.color,
                    lineStyle: config.lineStyle,
                    d4: config.d4 || 0,
                    d10: config.d10 || 0,
                    d12: config.d12 || 0
                }));

                updateConfigNames();
                runSimulation();
            } catch (error) {
                alert('Invalid JSON file: ' + error.message);
            }
        };

        // Functions
        // -Buttons
        function showLoading() {
            document.body.classList.add('disabled');
            document.getElementById('loadingOverlay').style.display = 'flex';
            console.log('loading...')
        }

        function hideLoading() {
            document.body.classList.remove('disabled');
            document.getElementById('loadingOverlay').style.display = 'none';
            console.log('complete!')
        }

        function moveConfigUp(button) {
            const configBox = button.closest('.config-box');
            const prev = configBox.previousElementSibling;
            if (prev) {
                configBox.parentNode.insertBefore(configBox, prev);
            }
        }

        function moveConfigDown(button) {
            const configBox = button.closest('.config-box');
            const next = configBox.nextElementSibling;
            if (next) {
                configBox.parentNode.insertBefore(next, configBox);
            }
        }

        function duplicateConfig(button) {
            const configBox = button.closest('.config-box');
            const config = {
                name: configBox.querySelector('.config-name').value,
                color: configBox.querySelector('.color-picker').value,
                lineStyle: configBox.querySelector('.line-style').value,
                d4: configBox.querySelectorAll('input[type="number"]')[0].value,
                d10: configBox.querySelectorAll('input[type="number"]')[1].value,
                d12: configBox.querySelectorAll('input[type="number"]')[2].value
            };

            addConfiguration(config);
        }

        function toggleYAxis() {
            yAxisLocked = !yAxisLocked;
            if (chart) {
                chart.options.scales.y.max = yAxisLocked ? 1 : undefined;
                chart.update();
            }
        }

        function addConfiguration(config = {}) {
            const container = document.getElementById('configurations-container');
            const configId = `config-${configCounter++}`;

            const defaultEmptyD10 = config.d10 === null || config.d10 === undefined ? 1 : config.d10

            const configHTML = `
                <div class="config-box" id="${configId}">
                    <div class="config-header">
                        <div class="config-controls">
                            <button onclick="moveConfigUp(this)">
                                <span class="material-symbols-outlined">arrow_left</span>
                            </button>
                            <button onclick="moveConfigDown(this)">
                                <span class="material-symbols-outlined">arrow_right</span>
                            </button>
                            <button onclick="duplicateConfig(this)">
                                <span class="material-symbols-outlined">content_copy</span>
                            </button>
                        </div>
                        <div>
                            <input type="text" class="config-name" placeholder="Configuration name" 
                                value="${config.name || ''}" 
                                style="margin-right: 10px; width: 150px;">
                            <input type="color" class="color-picker" value="${config.color || getRandomColor()}">
                            <select class="line-style" style="margin-left: 10px;">
                                <option value="solid">Solid</option>
                                <option value="dashed">Dashed</option>
                                <option value="dotted">Dotted</option>
                                <option value="dashDot">Dash-Dot</option>
                            </select>
                        </div>
                        <button onclick="document.getElementById('${configId}').remove()">
                            <span class="material-symbols-outlined">delete_forever</span>
                        </button>
                    </div>
                    <div class="dice-inputs">
                        <div class="die-input-cont">D4
                            <div class="number-input">
                            <button onclick="this.parentNode.querySelector('input[type=number]').stepDown()">-</button>
                            <input type="number" min="0" max="5" value="${config.d4 || 0}">
                            <button onclick="this.parentNode.querySelector('input[type=number]').stepUp()">+</button>
                            </div>
                        </div>
                        <div class="die-input-cont">D10
                            <div class="number-input">
                            <button onclick="this.parentNode.querySelector('input[type=number]').stepDown()">-</button>
                            <input type="number" min="0" max="5" value="${defaultEmptyD10}">
                            <button onclick="this.parentNode.querySelector('input[type=number]').stepUp()">+</button>
                            </div>
                        </div>
                        <div class="die-input-cont">D12
                             <div class="number-input">
                            <button onclick="this.parentNode.querySelector('input[type=number]').stepDown()">-</button>
                            <input type="number" min="0" max="5" value="${config.d12 || 0}">
                            <button onclick="this.parentNode.querySelector('input[type=number]').stepUp()">+</button>
                            </div>
                        </div>
                    </div>
                </div>
    `;

            container.insertAdjacentHTML('beforeend', configHTML);
            updateConfigNames();
        }

        function clearExistingConfigs() {
            document.getElementById('configurations-container').innerHTML = '';
        }

        function exportToCSV() {
            showLoading();
            try {
                if (!currentData) return alert('Run a simulation first!');

                const headers = [
                    'Successes',
                    ...currentData.configs.map(c => `${c.name}|${c.color}|${c.lineStyle}`),
                    ...currentData.configs.map(c => `${c.name} (d4/d10/d12)`)
                ];

                const rows = currentData.labels.map((label, i) => [
                    label,
                    ...currentData.datasets.map(d => (d[label] || 0).toFixed(4)),
                    ...currentData.configs.map(c => `${c.d4}/${c.d10}/${c.d12}`)
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dice_comparison.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } finally {
                hideLoading();
            }

        }

        function importFromCSV() {
            csvFileInput.click();
            csvFileInput.value = null;
        }

        function exportToJSON() {
            showLoading();
            try {
                const configs = getAllConfigurations();
                if (configs.length === 0) return alert('No configurations to export!');

                const jsonData = JSON.stringify(configs, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dice_configs.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } finally {
                hideLoading();
            }
        }

        function importFromJSON() {
            jsonFileInput.click();
            jsonFileInput.value = null;
        }

        function updateConfigNames() {
            const configs = document.querySelectorAll('.config-box');
            configs.forEach((config, index) => {
                const nameInput = config.querySelector('.config-name');
                const diceInputs = config.querySelectorAll('input[type="number"]:not(.config-name)');
                const diceValues = Array.from(diceInputs).map(input => input.value);

                if (!nameInput.value) {
                    nameInput.placeholder = `Config ${index + 1} (${diceValues[0]}d4/${diceValues[1]}d10/${diceValues[2]}d12)`;
                }
            });
        }

        function getRandomColor() {
            return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
        }

        function getAllConfigurations() {
            return Array.from(document.querySelectorAll('.config-box')).map(config => {
                const numberInputs = config.querySelectorAll('input[type="number"]:not(.config-name)');
                return {
                    name: config.querySelector('.config-name').value || config.querySelector('.config-name').placeholder,
                    color: config.querySelector('.color-picker').value,
                    lineStyle: config.querySelector('.line-style').value,
                    d4: parseInt(numberInputs[0].value),
                    d10: parseInt(numberInputs[1].value),
                    d12: parseInt(numberInputs[2].value)
                };
            });
        }

        async function runSimulation() {
            showLoading();
            try {
                const configs = getAllConfigurations();
                if (configs.length === 0) return alert('Add at least one configuration!');

                // Run simulations in parallel with progress
                const results = await Promise.all(configs.map(async config => ({
                    ...config,
                    data: await simulateConfiguration(config)
                })));

                const allKeys = [...new Set(results.flatMap(r => Object.keys(r.data)))].map(Number).sort((a, b) => a - b);

                const datasets = results.map((config, index) => ({
                    label: config.name,
                    data: allKeys.map(k => config.data[k] || 0),
                    borderColor: config.color,
                    borderDash: getBorderDash(config.lineStyle),
                    tension: 0.1
                }));

                function getBorderDash(style) {
                    switch (style) {
                        case 'dashed': return [10, 5];
                        case 'dotted': return [3, 3];
                        case 'dashDot': return [10, 5, 3, 5];
                        default: return [];
                    }
                }

                currentData = {
                    configs,
                    labels: allKeys,
                    datasets: results.map(r => r.data)
                };

                if (chart) chart.destroy();

                chart = new Chart(document.getElementById('chart'), {
                    type: 'line',
                    data: { labels: allKeys, datasets },
                    options: {
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Probability (%)',
                                    color: '#ffffff',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 14,
                                        weight: 'regular'
                                    }
                                },
                                beginAtZero: true,
                                max: yAxisLocked ? 1 : undefined,
                                ticks: {
                                    color: '#ffffff',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 12
                                    },
                                    callback: value => `${(value * 100).toFixed(1)}%`
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Number of Successes',
                                    color: '#ffffff',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                type: 'linear',
                                ticks: {
                                    color: '#ffffff',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 12
                                    },
                                    stepSize: 1
                                },
                                grid: {
                                    color: 'rgba(255,255,255,0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#ffffff',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.7)',
                                bodyColor: '#ffffff',
                                titleColor: '#ffffff',
                                bodyFont: {
                                    family: 'Arial, sans-serif',
                                    size: 12
                                },
                                titleFont: {
                                    family: 'Arial, sans-serif',
                                    size: 14,
                                    weight: 'bold'
                                },
                                callbacks: {
                                    label: context =>
                                        `${context.dataset.label}: ${(context.parsed.y * 100).toFixed(1)}%`
                                }
                            }
                        }
                    }
                });
            } finally {
                hideLoading();
            }
        }

        function rollDie(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }

        function runTrial(config) {
            let dice = [];
            dice.push(...Array(config.d4).fill().map(() => ({ value: rollDie(4) })));
            dice.push(...Array(config.d10).fill().map(() => ({ value: rollDie(10) })));
            dice.push(...Array(config.d12).fill().map(() => ({ value: rollDie(12) })));

            let initialSuccesses = dice.filter(d =>
                (d.value === 10) ||
                (d.value >= 10)
            ).length;

            const remainingValues = dice
                .filter(d => d.value < 10 || (d.value === 10 && d.type === 'd12'))
                .map(d => d.value);

            let summedSuccesses = 0;
            const sortedValues = [...remainingValues].sort((a, b) => b - a);

            while (sortedValues.length > 0) {
                const current = sortedValues.shift();
                let target = 10 - current;
                let found = false;

                if (target < 0) continue;
                if (target === 0) {
                    summedSuccesses++;
                    continue;
                }

                let sum = 0;
                const usedIndices = [];
                for (let i = 0; i < sortedValues.length; i++) {
                    if (sum + sortedValues[i] <= target) {
                        sum += sortedValues[i];
                        usedIndices.push(i);
                        if (sum === target) {
                            found = true;
                            break;
                        }
                    }
                }

                if (found) {
                    summedSuccesses++;
                    usedIndices.reverse().forEach(i => sortedValues.splice(i, 1));
                }
            }

            return totalSuccesses = initialSuccesses + summedSuccesses;
        }

        function simulateConfiguration(config) {
            return new Promise(resolve => {
                const results = {};
                const trials = numTrialsInput.value;
                let completed = 0;
                const chunkSize = 1000; // Process in chunks to keep UI responsive

                function processChunk() {
                    for (let i = 0; i < chunkSize && completed < trials; i++, completed++) {
                        const totalSuccesses = runTrial(config);
                        results[totalSuccesses] = (results[totalSuccesses] || 0) + 1;
                    }

                    if (completed < trials) {
                        setTimeout(processChunk, 0);
                    } else {
                        const output = {};
                        Object.keys(results).forEach(k => {
                            output[k] = results[k] / trials;
                        });
                        resolve(output);
                    }
                }

                processChunk();
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }


    </script>
</body>

</html>